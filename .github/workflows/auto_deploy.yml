name: Auto Deploy to cPanel Host

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Build cleaned zip (PowerShell)
      shell: pwsh
      run: |
        pwsh -NoProfile -ExecutionPolicy Bypass -File ./prepare_deploy.ps1

    - name: Upload spm-clean.zip to server (SCP/SFTP)
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_PASS }}
        port: ${{ secrets.DEPLOY_PORT }}
        source: "spm-clean.zip"
        target: ${{ secrets.DEPLOY_PATH }}

    - name: Upload server helper (server_setup.sh)
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_PASS }}
        port: ${{ secrets.DEPLOY_PORT }}
        source: "server_setup.sh"
        target: ${{ secrets.DEPLOY_PATH }}

    - name: Run deployment script on server (SSH)
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_PASS }}
        port: ${{ secrets.DEPLOY_PORT }}
        script: |
          cd ${{ secrets.DEPLOY_PATH }}
          chmod +x server_setup.sh || true
          bash server_setup.sh
